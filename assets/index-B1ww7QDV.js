class a extends HTMLElement{get src(){return this.getAttribute("src")}set src(t){this.reflect("src",t)}get manualRender(){return this.hasAttribute("manual-render")}set manualRender(t){this.reflect("manual-render",t)}reflect(t,e){e===!1?this.removeAttribute(t):this.setAttribute(t,e===!0?"":e)}static get observedAttributes(){return["src"]}attributeChangedCallback(t,e,r){t==="src"&&this.connected&&!this.manualRender&&r!==e&&this.render()}constructor(t){super(),this.version="$VERSION",this.config={markedUrl:"https://cdn.jsdelivr.net/gh/markedjs/marked@4/marked.min.js",prismUrl:[["https://cdn.jsdelivr.net/gh/PrismJS/prism@1/prism.min.js","data-manual"],"https://cdn.jsdelivr.net/gh/PrismJS/prism@1/plugins/autoloader/prism-autoloader.min.js"],cssUrls:["https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.min.css","https://cdn.jsdelivr.net/gh/PrismJS/prism@1/themes/prism.min.css"],hostCss:":host{display:block;position:relative;contain:content;}:host([hidden]){display:none;}",...t,...window.ZeroMdConfig},this.root=this.hasAttribute("no-shadow")?this:this.attachShadow({mode:"open"}),this.root.prepend(...this.makeNodes('<div class="markdown-styles"></div><div class="markdown-body"></div>')),this.constructor.ready||(this.constructor.ready=Promise.all([!!window.marked||this.loadScript(this.config.markedUrl),!!window.Prism||this.loadScript(this.config.prismUrl)])),this.clicked=this.clicked.bind(this),this.manualRender||this.render().then(()=>setTimeout(()=>this.goto(location.hash),250)),this.observer=new MutationObserver(()=>{this.observeChanges(),this.manualRender||this.render()}),this.observer.observe(this,{childList:!0}),this.observeChanges()}observeChanges(){this.querySelectorAll('template,script[type="text/markdown"]').forEach(t=>{this.observer.observe(t.content||t,{childList:!0,subtree:!0,attributes:!0,characterData:!0})})}connectedCallback(){this.connected=!0,this.fire("zero-md-connected",{},{bubbles:!1,composed:!1}),this.waitForReady().then(()=>{this.fire("zero-md-ready")}),this.shadowRoot&&this.shadowRoot.addEventListener("click",this.clicked)}disconnectedCallback(){this.connected=!1,this.shadowRoot&&this.shadowRoot.removeEventListener("click",this.clicked)}waitForReady(){const t=this.connected||new Promise(e=>{this.addEventListener("zero-md-connected",function r(){this.removeEventListener("zero-md-connected",r),e()})});return Promise.all([this.constructor.ready,t])}fire(t,e={},r={bubbles:!0,composed:!0}){e.msg&&console.warn(e.msg),this.dispatchEvent(new CustomEvent(t,{detail:{node:this,...e},...r}))}tick(){return new Promise(t=>requestAnimationFrame(t))}arrify(t){return t?Array.isArray(t)?t:[t]:[]}onload(t){return new Promise((e,r)=>{t.onload=e,t.onerror=s=>r(s.path?s.path[0]:s.composedPath()[0])})}loadScript(t){return Promise.all(this.arrify(t).map(e=>{const[r,...s]=this.arrify(e),i=document.createElement("script");return i.src=r,i.async=!1,s.forEach(n=>i.setAttribute(n,"")),this.onload(document.head.appendChild(i))}))}goto(t){let e;try{e=this.root.querySelector(t)}catch{}e&&e.scrollIntoView()}clicked(t){if(t.metaKey||t.ctrlKey||t.altKey||t.shiftKey||t.defaultPrevented)return;const e=t.target.closest("a");e&&e.hash&&e.host===location.host&&e.pathname===location.pathname&&this.goto(e.hash)}dedent(t){t=t.replace(/^\n/,"");const e=t.match(/^\s+/);return e?t.replace(new RegExp(`^${e[0]}`,"gm"),""):t}getBaseUrl(t){const e=document.createElement("a");return e.href=t,e.href.substring(0,e.href.lastIndexOf("/")+1)}highlight(t){return new Promise(e=>{t.querySelectorAll('pre>code:not([class*="language-"])').forEach(s=>{const i=s.innerText.match(/^\s*</)?"markup":s.innerText.match(/^\s*(\$|#)/)?"bash":"js";s.classList.add(`language-${i}`)});try{window.Prism.highlightAllUnder(t,!0,e())}catch{window.Prism.highlightAllUnder(t),e()}})}makeNodes(t){const e=document.createElement("template");return e.innerHTML=t,e.content.children}buildStyles(){const t=s=>{const i=this.querySelector(s);return i?i.innerHTML||" ":""},e=this.arrify(this.config.cssUrls);return`<style>${this.config.hostCss}</style>${t('template[data-merge="prepend"]')}${t("template:not([data-merge])")||e.reduce((s,i)=>`${s}<link rel="stylesheet" href="${i}">`,"")}${t('template[data-merge="append"]')}`}async buildMd(t={}){const e=async()=>{if(!this.src)return"";const s=await fetch(this.src);if(s.ok){const i=await s.text();return window.marked.parse(i,{baseUrl:this.getBaseUrl(this.src),...t})}else return this.fire("zero-md-error",{msg:`[zero-md] HTTP error ${s.status} while fetching src`,status:s.status,src:this.src}),""},r=()=>{const s=this.querySelector('script[type="text/markdown"]');if(!s)return"";const i=s.hasAttribute("data-dedent")?this.dedent(s.text):s.text;return window.marked.parse(i,t)};return await e()||r()}getHash(t){let e=5381;for(let r=0;r<t.length;r++)e=(e<<5)+e^t.charCodeAt(r);return(e>>>0).toString(36)}async stampStyles(t){const e=this.getHash(t),r=this.root.querySelector(".markdown-styles");if(r.getAttribute("data-hash")!==e){r.setAttribute("data-hash",e);const s=this.makeNodes(t),i=[...s].filter(n=>n.tagName==="LINK"&&n.getAttribute("rel")==="stylesheet");return r.innerHTML="",r.append(...s),await Promise.all(i.map(n=>this.onload(n))).catch(n=>{this.fire("zero-md-error",{msg:"[zero-md] An external stylesheet failed to load",status:void 0,src:n.href})}),!0}}async stampBody(t,e){const r=this.arrify(e),s=this.getHash(t+JSON.stringify(r)),i=this.root.querySelector(".markdown-body");if(i.getAttribute("data-hash")!==s){i.setAttribute("data-hash",s),r.unshift("markdown-body"),i.setAttribute("class",r.join(" "));const n=this.makeNodes(t);return i.innerHTML="",i.append(...n),await this.highlight(i),!0}}async render(t={}){await this.waitForReady();const e=this.buildMd(t),r=await this.stampStyles(this.buildStyles());await this.tick();const s=await this.stampBody(await e,t.classes);this.fire("zero-md-rendered",{node:this,stamped:{styles:r,body:s}})}}customElements.define("zero-md",a);export{a as ZeroMd};
